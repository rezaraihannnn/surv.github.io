<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>REPORT GAMAS - TIF2 REGIONAL3</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css"/>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      margin-top: 20px;
    }
    .table-responsive {
      border-radius: 10px;
      overflow: hidden;
      background: white;
      padding: 10px;
    }
    table {
      font-size: 14px;
      table-layout: fixed;
      width: 100%;
    }
    th, td {
      word-wrap: break-word;
      white-space: normal;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #343a40;
      color: white;
    }
    th:nth-child(1), td:nth-child(1) { width: 5%; }
    th:nth-child(2), td:nth-child(2) { width: 10%; }
    th:nth-child(3), td:nth-child(3) { width: 10%; }
    th:nth-child(4), td:nth-child(4) { width: 12%; }
    th:nth-child(5), td:nth-child(5) { width: 20%; }
    th:nth-child(6), td:nth-child(6) { width: 10%; }
    th:nth-child(7), td:nth-child(7) { width: 10%; }
    th:nth-child(8), td:nth-child(8) { width: 10%; }
    th:nth-child(9), td:nth-child(9) { width: 10%; }
    th:nth-child(10), td:nth-child(10) { width: 10%; }
    th:nth-child(11), td:nth-child(11) { width: 10%; }
    th:nth-child(12), td:nth-child(12) { width: 10%; }
    th:nth-child(13), td:nth-child(13) { width: 10%; }

    .highlight-yellow {
      background-color: yellow !important;
    }

    #map {
      height: 400px;
      margin-bottom: 20px;
      border-radius: 10px;
    }

    .blinking-marker {
      background-color: yellow;
      border-radius: 100%;
      width:50px;
      height: 50px;
      animation: blink 1s infinite;
      border: 2px solid black;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.2; }
      100% { opacity: 1; }
    }

    #liveStatus { 
        font-size: 14px; 
        font-weight: bold; 
        margin-top: 5px; 
        color: green; 
    }

    body.dark-mode {
        background-color: #121212;
        color: #e0e0e0;
      }
      
      .dark-mode .table-responsive {
        background-color: #1e1e1e;
      }
      
      .dark-mode th {
        background-color: #222;
        color: #fff;
      }
      
      .dark-mode td {
        background-color: #2a2a2a;
        color: #e0e0e0;
      }
      
      .dark-mode .dataTables_wrapper .dataTables_paginate .paginate_button {
        color: #fff !important;
      }
      
      .dark-mode .form-check-label {
        color: #e0e0e0;
      }
      
      .dark-mode #liveStatus {
        color: #90ee90;
      }      

  </style>
</head>
<body>

  <div class="container">
    <h4 class="text-center">Peta Lokasi WITEL (Highlight Area Jawa Barat)</h4>
    <div id="map" class="shadow"></div>
    <div id="liveStatus">Status: <span class="text-success">Live</span> (Auto-refresh setiap 15 detik)</div>
  </div>

  <div class="container">
    <div class="d-flex justify-content-end p-2">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="darkModeToggle">
          <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
        </div>
      </div>      
    <h2 class="text-center my-3">REPORT GAMAS - TIF2 REGIONAL3</h2>
    <div class="table-responsive shadow">
      <table id="dataTable" class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>NO</th>
            <th>WITEL</th>
            <th>STO</th>
            <th>No Tiket</th>
            <th>Summary</th>
            <th>Reported Date</th>
            <th>SEGMEN</th>
            <th>Target TTR (JAM)</th>
            <th>Lama Open (JAM)</th>
            <th>Sisa TTR (JAM)</th>
            <th>Jml Anak Terelasi Open</th>
            <th>Jml Anak Terelasi Close</th>
            <th>Jumlah Tiket Relasi</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    $(document).ready(function () {
      const map = L.map('map').setView([-6.9147, 107.6098], 8);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Peta Â© OpenStreetMap contributors'
      }).addTo(map);

      const blinkingIcon = L.divIcon({ className: 'blinking-marker' });
      const markersGroup = L.layerGroup().addTo(map);

      const witelCoords = {
        "BANDUNG": [-6.9147, 107.6098],
        "BANDUNGBRT": [-6.9978, 107.4558],
        "TASIKMALAYA": [-7.3274, 108.2208],
        "KARAWANG": [-6.3059, 107.3546],
        "SUKABUMI": [-6.9214, 106.9269],
        "CIREBON": [-6.7320, 108.5523]
      };

      const table = $('#dataTable').DataTable({
        processing: true,
        serverSide: false,
        ajax: {
          url: "https://script.google.com/macros/s/AKfycby-6GIfyW9XCxefZa1V91gB5P8XPx7OOdWtI8jU25QmHrYS7pUAdAyCLRSFiRMuKsoeIg/exec",
          dataSrc: "",
          cache: true
        },
        columns: [
          { data: "NO" },
          { data: "WITEL" },
          { data: "STO" },
          { data: "No Tiket" },
          { data: "Summary" },
          { data: "REPORTED DATE" },
          { data: "SEGMEN" },
          { data: "TARGET TTR  (JAM)" },
          { data: "LAMA OPEN (JAM)" },
          { data: "SISA TTR (JAM)" },
          { data: "JML ANAK TERELASI STATUS       \u003C OPEN \u003E" },
          { data: "JML ANAK TERELASI  STATUS             \u003C CLOSE \u003E" },
          { data: "JUMLAH TIKET RELASI" }
        ],
        pageLength: 10,
        deferRender: true,
        ordering: false,
        autoWidth: false,
        dom: 'Bfrtip',
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
        initComplete: function () {
          table.page(0).draw('page');
        },
        rowCallback: function (row, data, index) {
          const sisaTTR = parseFloat(data["SISA TTR (JAM)"]);
          if (!isNaN(sisaTTR) && sisaTTR < 0) {
            $('td:eq(9)', row).addClass("highlight-yellow");
          }

          const witelRaw = data["WITEL"];
          const witel = witelRaw ? witelRaw.toUpperCase().replace(/\s+/g, "") : "";
          if (witelCoords[witel]) {
            const [lat, lng] = witelCoords[witel];
            L.marker([lat, lng], { icon: blinkingIcon })
              .addTo(markersGroup)
              .bindPopup(`Tiket di ${witelRaw}`);
          }
        }
      });

        // Auto-refresh setiap 15 detik + status
        setInterval(() => {
            markersGroup.clearLayers();
            table.ajax.reload(null, false);
            $("#liveStatus").html("Status: <span class='text-success'>Live</span> (Auto-refresh: " + new Date().toLocaleTimeString() + ")");
        }, 15000);
    });

    // Dark Mode toggle
    const toggle = document.getElementById('darkModeToggle');

    // Load preferensi dari localStorage
    if (localStorage.getItem('dark-mode') === 'enabled') {
    document.body.classList.add('dark-mode');
    toggle.checked = true;
    }

    toggle.addEventListener('change', function () {
        if (this.checked) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('dark-mode', 'enabled');
        } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('dark-mode', 'disabled');
        }
    });
  </script>
</body>
</html>
